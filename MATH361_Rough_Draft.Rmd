---
title: "Predicting Bike Share Ridership based on Weather Data in Seattle"
author: "Joey Rodriguez and Daniel Bhatti"
date: "2024-11-22"
output:
  pdf_document: default
  html_document: default
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#imports 
library(readr)
library(dplyr)
library(car)
library(tinytex)
library(ggplot2)
library(patchwork)
library(zoo)
```

# Introduction
A bike share system – or simply bike share – is a service available to residents and tourists of many North American cities. Bike share connects riders with bikes which they can rent and ride from their smartphone. People choose ride share for commuting and for leisure; along with other modes like private car, ride share, mass- and micro- transit, bike share is one option within a suite of transportation options,  designed by planners and engineers to get people where they need to go. 

The interaction between weather and ridership is intuitive. 
Favorable weather is marked by sunshine, warm temperatures, moderate humidity, and low wind speed. Humanity's proclivity for the outdoors is highest when the weather is uneventful. When the weather outside is frightful -- think freezing temperatures, gusty, and rainy conditions -- we prefer the indoors. Especially in the United States with its auto-centric development patterns, poor weather often justifies a ``mode-shift'' for those who own a car. When the weather is poor and the infrastructure allows for it, why not drive!?

In this paper, we will fit a regression model to several variables describing the weather in order to predict daily bicycle ridership by trip. We will later consider trip duration as our dependent variable. Seattle has a reputation as a rainy city, and it’s for good reason. There were 287 rainy days between 10/13/2014 and 08/30/2016, a total of 689 days! Yet bike share was active in Seattle over those 689 days, totaling 236,044 trips across the system.

```{r mapping, include=FALSE}
trip = read_csv('pronto-cycle-share-trip-data.csv')
# map unique dates to integers starting at 1

trip$date <- as.Date(trip$starttime, format = "%m/%d/%Y %H:%M") # strips the date from its current format
unique_dates <- sort(unique(trip$date)) # this collects unique dates
date_to_number <- setNames(seq_along(unique_dates), as.character(unique_dates)) # this maps unique date to the integers, starting at 1
trip$day_number = date_to_number[as.character(trip$date)] # this adds the integer mapping as a column, day_number
trip$count = 1 # this adds a one to each obs; useful for add
trip = select(trip, count, tripduration, day_number)

# construct new df, ridership, that aggregates trips by day
ridership = trip %>% group_by(day_number) %>%
  summarise(total_trips = sum(count),
            total_durations = sum(tripduration),
            .groups = 'drop')
```

```{r clean_data, include = FALSE}
weather = read_csv('weather.csv.xls')

weather$temp_range = weather$Max_Temperature_F - weather$Min_TemperatureF # calculates temperature range for each day

weather$date <- as.Date(weather$Date, format = "%m/%d/%Y") # strips the date from its current format

# maps unique date to the integers, like the chunk above
date_to_number <- setNames(seq_along(unique_dates), as.character(unique_dates))
weather$day_number = date_to_number[as.character(weather$date)]

weather = weather[,-1] # remove the old date

# this will be our data frame going forward
df = left_join(weather,ridership, by='day_number')
```
## Bike Ridership 
```{r expl_data, echo = FALSE}
par(mfrow=c(1,2))
plot(df$day_number, df$total_trips, xlab = "Day Number", ylab = "Total Bike Ridership")
plot(df$day_number, df$total_durations, xlab = "Day Number", ylab = "Combined Ride Durations (secs)")
```




# Methods/ Analysis
## Best Predictors
```{r rplot, echo=FALSE}
par(mfrow=c(2,2))
plot(df$Precipitation_In,df$total_trips)
plot(df$Mean_Temperature_F,df$total_trips)
plot(df$Mean_Humidity,df$total_trips)
plot(df$Mean_Wind_Speed_MPH, df$total_trips)

out = lm(total_trips ~ Mean_Temperature_F, data = df)
par(mfrow=c(2,2))
plot(out)
summary(out)
#Adjusted R^2 is 0.5612

outHum = lm(total_trips ~ Mean_Humidity, data = df)
par(mfrow=c(2,2))
plot(outHum)
summary(outHum)
#Diagnostic plots look incredible. Adj R^2 = 0.4611

outRain = lm(total_trips ~ Precipitation_In, data = df)
par(mfrow=c(2,2))
plot(outRain)
summary(outRain)

outWind = lm(total_trips ~ Mean_Wind_Speed_MPH, data =df)
par(mfrow=c(2,2))
plot(outWind)
summary(outWind)
#Plots bad, R^2 <0.2


```

```{r something}
rainResiduals <- resid(outRain)
windResiduals <- resid(outWind)

variance_rain = lm(abs(windResiduals) ~ Mean_Wind_Speed_MPH, data = df)

rainpredictedvar = predict(variance_rain)

rainweights = 1/(rainpredictedvar^2)

RainWLS <- lm(total_trips ~ Precipitation_In, data = df, weights = rainweights)

#RainWLS did not produce meaningful improvements.

outDew = lm(total_trips ~ MeanDew_Point_F, data = df)

#Great plots R^2 is only 0.2

outWind = lm(total_trips ~ Mean_Wind_Speed_MPH, data = df)

#Good plots R^2 is a paltry 0.07

windweights <- 1/lm(abs(outWind$residuals)~outWind$fitted.values)$fitted.values^2

WindWLS <- lm(total_trips ~ Mean_Wind_Speed_MPH, data = df, weights = windweights)

#Using WLS on windspeed significantly improves it. The R^2 is 0.7

outRange = lm(total_trips ~ temp_range, data = df)

#Plots have 1 extremely influential point, the R^2 is 0.315
#If we are to use mean temp I think we can ignore this variable (as a basic regressor)

outVisible = lm(total_trips ~ Mean_Visibility_Miles, data = df)

#Plots are mid, R^2 is 0.1313

visresid =  resid(outVisible)

variance_vis = lm(abs(visresid)~Mean_Visibility_Miles, data=df)

vispredictvar = predict(variance_vis)

visweights = 1/(vispredictvar^2)

VisWLS <- lm(total_trips ~ Mean_Visibility_Miles, data = df, weights = visweights)

#Very unimpressive.

outSea = lm(total_trips ~ Mean_Sea_Level_Pressure_In, data = df)

#Criteria for being in full model is that it had a *** significance by itself

fullmodel = lm(total_trips ~ Mean_Temperature_F + Mean_Humidity+MeanDew_Point_F+Precipitation_In+Mean_Wind_Speed_MPH+Mean_Visibility_Miles, data = df)

#Very interestingly Mean temp is not significant. Additionally visibility is far from significant

#Diagnostic plots look very good. R^2 is 0.71

partialmodel = lm(total_trips ~ Mean_Temperature_F + Mean_Humidity+MeanDew_Point_F+Precipitation_In+Mean_Wind_Speed_MPH, data = df)

partialmodel2 = lm(total_trips ~ Mean_Humidity+MeanDew_Point_F+Precipitation_In+Mean_Wind_Speed_MPH, data = df)

#Good diagnostics, R^2 is 0.71, all regressors are significant.

#I think that this is the best model.

testmodel = lm(total_trips ~ Mean_Temperature_F + MeanDew_Point_F, data=df)

#R^2 0.63, good diagnostics.

testmodel2 = lm(total_trips ~ Mean_Temperature_F + Mean_Humidity, data=df)

#R^2 0.6487, good diagnostics

testmodel3 = lm(total_trips ~ Mean_Temperature_F + Mean_Humidity+MeanDew_Point_F, data=df)

#Suddenly temperature is not significant


#powerTransform(cbind(df$total_trips,df$Mean_Temperature_F,df$#Mean_Humidity,df$MeanDew_Point_F,df$Precipitation_In,df$Mean_#Wind_Speed_MPH,df$Mean_Visibility_Miles))

#This fails as powerTransform needs arguments to be strictly positive and the min
#of Precipitation and Wind speed are 0

powerTransform(cbind(df$total_trips,df$Mean_Temperature_F,df$Mean_Humidity,df$MeanDew_Point_F,df$Mean_Visibility_Miles))

#trips: 0.761, Temperature: 0.760, Humidity: 0.67, Dew point 1.1, Visibility 10

#Therefore trips 3/4, temperate 3/4, humidity 2/3, Dew point no change visibility, visibility^2

df$total_trips_trans <- df$total_trips^(3/4)
df$Mean_Temperature_F_trans <- df$Mean_Temperature_F^(3/4)
df$Mean_Humidity_trans <- df$Mean_Humidity^(2/3)
df$Mean_Visibility_Miles_trans <- df$Mean_Visibility_Miles^2

df$total_trips_trans <- df$total_trips^(3/4)
df$Mean_Temperature_F_trans <- df$Mean_Temperature_F^(3/4)
df$Mean_Humidity_trans <- df$Mean_Humidity^(2/3)
df$Mean_Visibility_Miles_trans <- df$Mean_Visibility_Miles^10

transform_out <- lm(total_trips_trans ~ Mean_Temperature_F_trans + Mean_Humidity_trans + MeanDew_Point_F + Mean_Visibility_Miles_trans, data = df)

#The transformed model is not very impressive. Good diagnostics, R^2 of 0.6484

partialmodel3 = lm(total_trips ~ Mean_Humidity+MeanDew_Point_F+Precipitation_In+Mean_Wind_Speed_MPH+Max_Temperature_F, data = df)

#Best model

```

## Conclusion/Discussion

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. 


```{r, echo=FALSE, include=FALSE}
cor(df$total_durations,df$total_trips)
#Total trips and total durations are only 82.2% correlated

cor(df$total_durations, df$Mean_Temperature_F, use = "complete.obs")

cor(df$total_durations, df$MeanDew_Point_F)


```





